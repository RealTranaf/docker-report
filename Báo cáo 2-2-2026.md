<h1 align='center'>Thực hành deploy project thực lên Docker Container</h1>

Cụ thể: Deploy một project web app full stack lên các container Docker.

Project sử dụng:

Back-end (Cụ thể commit này): https://github.com/RealTranaf/sapo-pos-system/tree/c5d062d655d599e9a69ebed5331f4d38eec58160

Front-end (Cụ thể commit này): https://github.com/RealTranaf/customer-owner-module/tree/44bce445e94e07018facda5738219529cae43c87

Back-end: ứng dụng sử dụng framework Spring Boot kết nối với CSDL MySQL để quản lý dữ liệu.

Front-end: giao diện web sử dụng thư viện ReactJS kết nối với back-end để trình bày dữ liệu và nhận input từ phía người dùng.

Cần tạo 3 image cho CSDL, Back-end và Front-end và 3 container tương ứng. Các container sẽ được kết nối với nhau sử dụng Docker Compose.

**Back-end và CSDL**

File config gốc của back-end:

spring.application.name=mock-project-pos-system

spring.datasource.url=jdbc:mysql://localhost:3306/pos_system
spring.datasource.username=root
spring.datasource.password=root
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
spring.jpa.generate-ddl=true
spring.jpa.open-in-view = true
spring.jpa.hibernate.ddl-auto = update

security.jwt.secret-key=b5a990c585b64cf4fc5b77f6af5c5d2e2c126dd60246b8572ad4be5092754d33
security.jwt.expiration-time=3600000

Khi deploy lên container, không thể để các url dưới dạng localhost được do database và back-end chạy ở 2 container khác nhau, không nằm trong cùng 1 máy nên ko thể gọi tới localhost => phải trỏ url mysql như sau:

spring.application.name=mock-project-pos-system

spring.datasource.url=jdbc:mysql://mysql:3306/pos_system_docker
spring.datasource.username=root
spring.datasource.password=root
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

spring.jpa.generate-ddl=true
spring.jpa.open-in-view = true
spring.jpa.hibernate.ddl-auto = update

security.jwt.secret-key=b5a990c585b64cf4fc5b77f6af5c5d2e2c126dd60246b8572ad4be5092754d33
security.jwt.expiration-time=3600000

Dockerfile cho back-end:

FROM eclipse-temurin:17-jdk-alpine

WORKDIR /app

COPY target/mock-project-pos-system-0.0.1-SNAPSHOT.jar app.jar

EXPOSE 8080

ENTRYPOINT ["java", "-jar", "app.jar", "--spring.profiles.active=docker"]

- FROM eclipse-temurin:17-jdk-alpine: image nền tảng cho back-end, là một JDK mã nguồn mở phổ biến. Sử dụng Java 17 phiên bản dành cho distro Alpine nhỏ gọn.
- WORKDIR /app: Đặt /app là thư mục làm việc của container.

- COPY target/mock-project-pos-system-0.0.1-SNAPSHOT.jar app.jar: 

    - Copy JAR đã build từ máy host vào container.

    - Để có được file JAR này, trước tiên phải chạy mvn clean package -DskipTests để build.

- EXPOSE 8080: chạy ở port 8080 của container.

- ENTRYPOINT ["java", "-jar", "app.jar", "--spring.profiles.active=docker"]: những lệnh chính được thực hiện khi bắt đầu container: chạy app.jar, sử dụng profile config riêng cho docker.

**Front-end**

Dockerfile: 

FROM node:20-alpine AS build
WORKDIR /app

COPY package*.json ./
RUN npm install

COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=build /app/build /usr/share/nginx/html
EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]

- FROM node:20-alpine AS build: Xây dựng image trên nền tảng nodeJS phiên bản 20 cho distro Alpine.

- WORKDIR /app: Đặt /app là thư mục làm việc của container.

- COPY package*.json ./ và RUN npm install: copy file package.json và package-lock.json và chạy lệnh npm install để tải về các dependency và thư viện cần cho front-end. Copy những file này trước để Docker có thể cache các layer này, đảm bảo rằng các dependency chỉ cần tải lại nếu có sự thay đổi ở 2 file trên.

- COPY . .: copy toàn bộ source code vào container.

- RUN npm run build: chạy script để build ứng dụng.

- FROM nginx:alpine: bắt đầu 1 image mới chỉ chạy nginx, ko có nodeJS => nhỏ gọn hơn.

- COPY --from=build /app/build /usr/share/nginx/html: copy các file đã build vào thư mục web gốc của nginx (lấy các file từ giai đoạn trước có tên build)

- EXPOSE 80: container hoạt động ở port 80.

- CMD ["nginx", "-g", "daemon off;"]: chạy nginx nổi


**Docker Compose**

File compose là mấu chốt để gắn kết các container lại với nhau.

version: "3.9"

```
services:
  mysql:
    image: mysql:8.0
    container_name: mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: pos_system_docker
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - app-network

  backend:
    build: ./sapo-pos-system
    container_name: backend
    restart: always
    environment:
      SPRING_PROFILES_ACTIVE: docker
    depends_on:
      - mysql
    ports:
      - "8080:8080"
    networks:
      - app-network

  frontend:
    build: ./customer-owner-module
    container_name: frontend
    restart: always
    depends_on:
      - backend
    ports:
      - "3000:80"
    networks:
      - app-network

volumes:
  mysql_data:

networks:
  app-network:
    driver: bridge
```
1. mysql:

```
mysql:
  image: mysql:8.0
  container_name: mysql
  restart: always
```
- Sử dụng image MySQL 8.0
- đặt tên container là mysql
- luôn restart mysql trong trường hợp sập hoặc docker restart.

```
environment:
  MYSQL_ROOT_PASSWORD: root
  MYSQL_DATABASE: pos_system_docker
```
- Password root: root
- Tạo db pos_system_docker khi khởi tạo.
```
volumes:
  - mysql_data:/var/lib/mysql
```
- Thiết lập persistance dạng volume cho file của db.
```
networks:
  - app-network
```
- Kết nối MySQL tới network bridge cùng với các container khác.

2. back-end:

```
backend:
  build: ./sapo-pos-system
  container_name: backend
  restart: always
```

- build image từ thư mục local sử dụng dockerfile trong thư mục đó.

```
environment:
  SPRING_PROFILES_ACTIVE: docker
```
- sử dụng config được tạo cho docker.
```
depends_on:
  - mysql
```
- Đảm bảo rằng container MySQL được khởi động trước container back-end.
```
ports:
  - "8080:8080"
```
- Map port 8080 của host với port 8080 của container.
```
networks:
  - app-network
```
- Back-end có thể giao tiếp với container mysql và frontend

3. front-end:

```
frontend:
  build: ./customer-owner-module
  container_name: frontend
  restart: always
```
- Build frontend từ thư mục local sử dụng dockerfile trong thư mục đó.

```
depends_on:
  - backend
```
- Chạy container backend trước.
```
ports:
  - "3000:80"
```
- Map port 3000 của host với port 80 của container.
```
networks:
  - app-network
```
- Front-end có thể giao tiếp với backend

**Volume**

```
volumes:
  mysql_data:
```
- Khai báo volume để lưu trữ dữ liệu của db.

**Network**

```
networks:
  app-network:
    driver: bridge
```
- Tạo một network chung để các container có thể giao tiếp với nhau.









